# Content-negotiation (내용 협상)

하나의 URL에 여러 리소스에 대응할 필요가 있는 경우가 있다

예를 들어서 콘텐츠를 여러 언어로 제공하고자 하는 경우 내용 협상을 하여 어떤 언어로 제공할지 적절하게 제공하거나 선택을 하게 하여 제공할 수 있게 한다

- 클라이언트 주도 기법
- 서버 주도 기법
- 투명 기법

## 클라이언트 주도 기법

클라이언트가 요청을 보내면 서버는 클라이언트에게 선택지를 보내주고 클라이언트가 선택한다

서버입장에서 구현하기 쉬우며 클라이언트는 최선의 선택을 할 수 있다는 장점이 있다

대기시간이 증가하고 올바른 컨텐츠를 얻으려면 최소 두번의 요청이 필요한 단점이 있다

## 서버 주도 기법

서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정할 수 있다

클라이언트 주도 기법보다 빠르며 HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 매커니즘을 제공하고 Vary 헤더를 제공하여 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄 수 있도록 한다

하지만 맞는 헤더가 없다면 서버는 추측해야만 하는 단점이 있다

### 서버 주도 기법에서의 응답 매커니즘

- 내용 협상에 대한 헤더를 살펴보는데, 서버는 클라이언트의 Accept 관련 헤더들을 들여다보고 알맞은 응답 헤더를 준비한다

- 내용 협상 헤더 외의 다른 헤더들을 찾아본다. 예를 들어, User-Agent 헤더에 기반하여 응답을 보내줄 수도 있다

|      헤더       |      설명            |
|-----------------|---------------------|
| Accept          | 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다 |
| Accept-Language | 서버가 어떤 언어로 보내도 되는지 알려준다 |
| Accept-Charset  | 서버가 어떤 캐릭터셋으로 보내도 되는지 알려준다 |
| Accept-Encoding | 서버가 어떤 인코딩으로 보내도 되는지 알려준다 |

엔터티 헤더와 내용 협상 헤더들은 비슷하지만 차이가 있는데, 엔터티 헤더는 본문의 속성과 같고 내용 협상 헤더는 클라이언트와 서버가 정보를 서로 교환하고 문서들의 여러 버전 중 하나를 선택하는 것을 도와, 가장 적절한 문서를 제공해주기 위한 목적으로 사용된다

| Accept 관련 헤더 | 엔터티 헤더    |
|-----------------|---------------------|
| Accept          | Content-Type |
| Accept-Language | Content-Language |
| Accept-Charset  | Content-Type |
| Accept-Encoding | Content-Encoding |

클라이언트 중 제공하지 않는 언어를 선호한다면 서버는 능력껏 추측하거나 클라이언트 주도 모델로 전환하여 물어볼 수 있다. 다르게 최소한의 언어능력 정도를 측정할 수 있는 품질값(q)를 이용해서 좀 더 적절한 컨텐츠를 제공할 수 있는 방법도 존재한다

```
Accept-Language: en;q=0.5, fr:q=0.0, nl;q=1.0, tr;q=0.0
```

q값은 0.0부터 1.0까지의 값을 가질 수 있으며 1.0에 가까울수록 선호도가 높다

해당 내용 협상 헤더에는 네덜란드어를 가장 선호하며 다음으로 영어로를 선호하고 있지만 터키어와 프랑스어는 원하지 않고 있다

대응하는 문서가 없을 경우에는 서버는 문서를 고치거나 트랜스코딩할 수 있다고 한다

그 외 `User-Agent`에는 q값 매커니즘은 존재하지 않고 권장하지 않는 방식


## 투명 기법

주로 프록시가 서버를 대신하여 협상하는 방법으로 제공한다

서버가 협상을 할 필요가 없으며 클라이언트 주도 협상보다 빠르다

정형화된 명세가 없다는 단점이 있다

### Vary 응답 헤더

mdn에서는 서버 주도 기법에서 소개가 되기도 한다.

고려한 클라이언트 요청 헤더 모두를 나열한다. 제공된 문서가 User-Agent에 의존한다면, Vary 헤더는 반드시 User-Agent를 포함해야 한다

새 요청이 들어오면 캐시는 내용 협상 헤더들을 이용해 가장 잘 맞는 것을 찾는다. 하지만, 캐시는 쿨라이언트에게 제공해주기 전에 Vary 헤더가 있는지 확인해야 한다. Vary 헤더가 명시되어 있는 헤더들은 새 요청과 오래된 캐시된 요청에서 그 값이 서로 맞아야 한다고 한다

캐시는 각 배리언트마다 알맞은 문서 버전을 저장해야 한다. 만약 맞는 것이 없으면, 캐시는 서버에서 문서를 가져온다